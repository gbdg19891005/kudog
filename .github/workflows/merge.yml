name: Merge and Group M3U Files

on:
  schedule:
    - cron: "0 2 * * *"   # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write   # ğŸ‘ˆ å…³é”®ï¼šå…è®¸ Actions å†™å…¥ä»“åº“

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests

      - name: Merge kudog.txt + interface.txt with grouping
        run: |
          python <<'EOF'
          import requests, re

          # GitHub ä¸Šçš„ interface.txt
          url = "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"
          resp = requests.get(url)
          github_content = resp.text.splitlines()

          # æœ¬åœ° kudog.txt
          with open("kudog.txt", "r", encoding="utf-8") as f:
              kudog_content = f.read().splitlines()

          # åˆå¹¶ï¼Œä¿ç•™ä¸€ä¸ª #EXTM3U
          merged = ['#EXTM3U x-tvg-url="https://epg.catvod.com/epg.xml"']
          all_lines = github_content[1:] + kudog_content[1:]

          def assign_group(name: str) -> str:
              if "CCTV" in name.upper():
                  return "CCTV"
              if re.search("æ–°è|æ–°é—»|NEWS", name, re.IGNORECASE):
                  return "æ–°é—»"
              if re.search("ç¶œè—|ç»¼è‰º", name):
                  return "ç»¼è‰º"
              if re.search("é«”è‚²|ä½“è‚²|SPORT", name, re.IGNORECASE):
                  return "ä½“è‚²"
              if re.search("é›»å½±|ç”µå½±|MOVIE|CINEMA", name, re.IGNORECASE):
                  return "ç”µå½±"
              if re.search("å°‘å„¿|å…’ç«¥|KIDS|Cartoon|å‹•æ¼«|åŠ¨ç”»", name, re.IGNORECASE):
                  return "å°‘å„¿"
              return "ç»¼åˆ"

          # éå†å¹¶ä¿®æ­£ group-title
          for i in range(0, len(all_lines), 2):
              if all_lines[i].startswith("#EXTINF"):
                  line = all_lines[i]
                  url_line = all_lines[i+1] if i+1 < len(all_lines) else ""
                  # æå–é¢‘é“å
                  match = re.search(r'tvg-name="([^"]+)"', line)
                  name = match.group(1) if match else "æœªçŸ¥é¢‘é“"
                  group = assign_group(name)
                  # æ›¿æ¢æˆ–æ·»åŠ  group-title
                  if "group-title" in line:
                      line = re.sub(r'group-title=".*?"', f'group-title="{group}"', line)
                  else:
                      line = line + f' group-title="{group}"'
                  merged.append(line)
                  merged.append(url_line)

          # ä¿å­˜åˆå¹¶åçš„æ–‡ä»¶
          with open("merged.m3u", "w", encoding="utf-8") as f:
              f.write("\n".join(merged))
          EOF

      - name: Commit merged.m3u
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add merged.m3u
          git commit -m "Auto update merged.m3u with grouping" || echo "No changes"
          git push
